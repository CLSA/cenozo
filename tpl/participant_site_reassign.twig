{##
 # participant_site_reassign.twig
 # 
 # Form to mass reassign the preferred site of multiple participants
 # @author Patrick Emond <emondpd@mcmaster.ca>
 # @see widget.twig for parameters
 #}
{% extends "widget.twig" %}

{% block javascript %}

  {{ parent() }}
  <script type="text/javascript">
    $( function () {
      
      // service drop-down changed
      $( "#{{ widget.full }}__service_id" ).change( function () {
        populate_site_list( $( "#{{ widget.full }}__service_id" ).val() );
      } );

      // proceed button clicked
      $( "#{{ widget.full }}__proceed" ).click( function () {
        var args = new Object();
        args.service_id = $( "#{{ widget.full }}__service_id" ).val();
        args.site_id = $( "#{{ widget.full }}__site_id" ).val();
        args.uid_list = $( "#{{ widget.full }}__uid_list" ).val();
        if( ajax_push( "participant", "site_reassign", args ) ) slot_prev( {{ slot }} );
      } );
    
      // populate the list on load
      populate_site_list( $( "#{{ widget.full }}__service_id" ).val() );
    } );

    // populate site drop-down with the selected service's sites
    function populate_site_list( service_id ) {
      var options = {
        {% for service in services %}
          "{{ service.id }}": {
            "0": "None",
            {% for site in service.sites %}
              "{{ site.id }}": "{{ site.name }}",
            {% endfor %}
          },
        {% endfor %}
      };

      // remove all options and replace them with the choosen service's sites
      $site_select = $( "#{{ widget.full }}__site_id" );
      $site_select.children().remove();
      $.each( options[service_id], function( key, value ) {
        $site_select.append( $('<option>', { value: key } ).text( value ) );
      } );
    }
  </script>

{% endblock javascript %}

{% block widget %}
  <div class="ui-widget ui-widget-content app-widget-content">
    <div class="spacer">
      <p>
        Provide a list of participant UIDs which you wish to set the preferred site to.
        UIDs must be separated by a comma or space and may be qualified by single
        or double quotes (ie: A123456 B123456 C123456).
      </p>
    </div>
    <table>
      {% if 1 < services|length %}
        <tr>
          <td class="heading">
            <span class="title">Service:</span>
          </td>
          <td class="content">
             <select id="{{ widget.full }}__service_id" style="width: 100%" class="ui-state-default">
              {% for service in services %}
                <option value="{{ service.id }}">{{ service.name }}</option>
              {% endfor %}
             </select>
          </td>
        </tr>
      {% else %}
        {% for service in services %}
          <input id="{{ widget.full }}__service_id" type="hidden" value="{{ service.id }}" />
        {% endfor %}
      {% endif %}
      <tr>
        <td class="heading">
          <span class="title">Preferred Site:</span>
        </td>
        <td class="content">
          <select id="{{ widget.full }}__site_id" style="width: 100%" class="ui-state-default">
            <option value="0">None</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="heading">
          <span class="title">UID list:</span>
        </td>
        <td class="content">
          <textarea id="{{ widget.full }}__uid_list" style="height: 16em;"></textarea>
        </td>
      </tr>
    </table>
    <div class="spacer" style="text-align: right">
      <button id="{{ widget.full }}__proceed" style="width:120px">Proceed</button>
    </div>
  </div>
{% endblock widget %}
