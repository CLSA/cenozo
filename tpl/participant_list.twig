{##
 # participant_list.twig
 # 
 # Lists participants.
 # @author Patrick Emond <emondpd@mcmaster.ca>
 # @see base_list.twig for parameters
 #}
{% extends "site_restricted_list.twig" %}

{% from 'macros.twig' import note_widget %}

{% block javascript %}
  {{ parent() }}

  {% if conditions is defined %}
    <script type="text/javascript">
      $( function() {
        // reload page if condition selector is changed
        $( "#{{ widget.full }}__restrict_condition" ).change( function() {
          var condition = $( "#{{ widget.full }}__restrict_condition option:selected" ).val();
          slot_load( {{ slot }}, "{{ widget.subject }}", "{{ widget.name }}", 
                     { "restrict_condition": condition } );
        } );

        // search button shows/hides search dialog
        $( "#{{ widget.full }}__search" ).button().click( function() {
          $dialog = $( "#{{ widget.full }}__search_dialog" );
          if( $dialog.is( ":visible" ) ) $dialog.hide( "slow" );
          else $dialog.show( "slow" );
        } );

        // identify a mutable element by changing classes on mouse over/out
        $( "div.mutable" ).mouseover( function() {
          $(this).removeClass( "padded" );
          $(this).addClass( "ui-widget-content" );
        } );
        $( "div.mutable" ).mouseout( function() {
          $(this).removeClass( "ui-widget-content" );
          $(this).addClass( "padded" );
        } );

        // make the search dialog elements jeditable
        var jeditable_params = new Object();
        jeditable_params.tooltop = "click to edit";
        jeditable_params.cssclass = "ui-state-default";
        jeditable_params.event = "click";
        jeditable_params.onblur = "cancel";
        jeditable_params.placeholder = "&nbsp;";
        jeditable_params.submit = "save";
        jeditable_params.cancel = "cancel";
        jeditable_params.type = "text";
        $( "#{{ widget.full }}__search_phone" ).editable( function( value, settings ) {
          return value;
        }, jeditable_params );
        $( "#{{ widget.full }}__search_postcode" ).editable( function( value, settings ) {
          return value;
        }, jeditable_params );

      } );
    </script>
  {% endif %}

{% endblock javascript %}

{% block prelist %}
  
  {% if conditions is defined %}
    {% set restrict_condition = restrict_condition|default("") %}
    <label for="{{ widget.full }}__restrict_condition">Restrict to condition:</label>
    <select id="{{ widget.full }}__restrict_condition" class="ui-state-default"
            style="margin-top:4px;margin-bottom:4px;">
      <option {% if "" == restrict_condition %}selected{% endif %}
              value="">No restriction</option>
      {% for name in conditions %}
        <option {% if name == restrict_condition %}selected{% endif %}
                value="{{ name }}">{{ name }}</option>
      {% endfor %}
    </select>
  {% endif %}
  {{ parent() }}
  <button id="{{ widget.full }}__search">Search</button>
  <div id="{{ widget.full }}__search_dialog"
       class="ui-widget-content"
       style="display:none; margin-left:20%; margin-right:20%; margin-top:1%; margin-bottom:1%">
    <table>
      <tr>
        <td class="heading">Phone:</td>
        <td class="content">
          <div id="{{ widget.full }}__search_phone" class="mutable padded"></div>
        </td>
      </tr>
      <tr>
        <td class="heading">Postcode:</td>
        <td class="content">
          <div id="{{ widget.full }}__search_postcode" class="mutable padded"></div>
        </td>
      </tr>
    </table>
  </div>

{% endblock prelist %}

{% block header_button_columns %}
  <th width="1%"></th>
{% endblock header_button_columns %}

{% block button_columns %}
  <td>{{ note_widget( widget.full,
                      "participant",
                      row.id,
                      false,
                      row.columns['participant.note_count'] ) }}</td>
{% endblock button_columns %}
